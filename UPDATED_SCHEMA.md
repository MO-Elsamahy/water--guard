# تحديث قاعدة البيانات - النظام الجديد للمستخدمين

## الميزات الجديدة

### 1. أنواع المستخدمين الثلاثة:

#### أ) المستخدم العادي (User):
- **الصلاحيات:**
  - تسجيل الدخول والخروج
  - إنشاء ونشر أخبار (تحتاج موافقة الإدارة)
  - تعديل الملف الشخصي (الاسم، رقم الهاتف، النبذة، الموقع، الموقع الإلكتروني)
  - رفع صورة شخصية
  - إرسال تقارير المشاكل
  - تصفح دليل السباكين
  - تصفح الأخبار المنشورة

#### ب) السباك (Plumber):
- **الصلاحيات:**
  - تسجيل الدخول والخروج
  - تعديل الملف الشخصي الأساسي والمهني
  - رفع صورة شخصية ورخصة العمل
  - تحديث حالة التوفر
  - تصفح الأخبار والتقارير
  - التواصل مع العملاء
- **القيود:**
  - لا يمكنه إنشاء أخبار
  - يحتاج موافقة الإدارة للظهور في الدليل

#### ج) المدير (Admin):
- **الصلاحيات الكاملة:**
  - إدارة جميع المستخدمين
  - الموافقة على الأخبار أو رفضها
  - الموافقة على التقارير أو رفضها
  - الموافقة على السباكين أو رفضهم
  - إنشاء ونشر أخبار مباشرة (بدون موافقة)
  - حذف وتعديل أي محتوى
  - الوصول للوحة التحكم الإدارية

### 2. الجداول الجديدة:

#### أ) `user_profiles` - الملفات الشخصية الإضافية:
```sql
- id (UUID) - مرجع للمستخدم
- bio (TEXT) - نبذة تعريفية
- location (TEXT) - الموقع
- website (TEXT) - الموقع الإلكتروني
- social_links (JSONB) - روابط وسائل التواصل
- preferences (JSONB) - التفضيلات
- notification_settings (JSONB) - إعدادات الإشعارات
```

#### ب) تحديثات على جدول `news`:
```sql
- status (TEXT) - حالة الخبر: pending/approved/rejected
- approved_by (UUID) - من وافق على الخبر
- approved_at (TIMESTAMP) - وقت الموافقة
- rejection_reason (TEXT) - سبب الرفض
```

### 3. الصفحات الجديدة:

#### أ) `/profile` - الملف الشخصي:
- تعديل البيانات الأساسية
- رفع صورة شخصية
- إدارة النبذة التعريفية والمعلومات الإضافية
- عرض نوع المستخدم وصلاحياته

#### ب) `/create-news` - إنشاء خبر:
- متاح للمستخدمين العاديين والمدراء فقط
- نموذج شامل لإنشاء الأخبار
- رفع صور مرفقة
- اختيار الفئة والكلمات المفتاحية
- إرسال للمراجعة (للمستخدمين العاديين)

### 4. تحديثات الـ Navigation:

#### أ) Navbar:
- رابط "إنشاء خبر" (للمستخدمين العاديين والمدراء فقط)
- رابط "الملف الشخصي" في القائمة المنسدلة
- عرض نوع المستخدم في القائمة

#### ب) الأيقونات الجديدة:
- `CategoryIcon` - لفئات الأخبار
- `TagIcon` - للكلمات المفتاحية
- `ImageIcon` - لرفع الصور
- `LocationIcon` - للمواقع

### 5. الخدمات المحدثة:

#### أ) `UserService`:
- إدارة الملفات الشخصية
- رفع الصور الشخصية
- تحديث البيانات

#### ب) `NewsService`:
- إنشاء أخبار للمستخدمين
- نظام الموافقة/الرفض
- رفع صور الأخبار

#### ج) `PlumberService` و `ReportService`:
- محدثة للعمل مع النظام الجديد
- دعم الملفات الشخصية الموسعة

## خطوات التطبيق:

### 1. تحديث قاعدة البيانات:
```bash
# في Supabase Dashboard > SQL Editor
# تشغيل ملف supabase-schema.sql المحدث
```

### 2. تحديث الكود:
- تم إنشاء `supabase-services-v2.ts` مع الخدمات الجديدة
- تحديث جميع الصفحات للعمل مع النظام الجديد
- إضافة الصفحات الجديدة (`/profile`, `/create-news`)

### 3. الاختبار:
1. تسجيل مستخدمين من الأنواع الثلاثة
2. اختبار الصلاحيات لكل نوع
3. اختبار نظام الموافقة على الأخبار
4. اختبار الملفات الشخصية

## الميزات المستقبلية:

### 1. لوحة التحكم الإدارية:
- صفحة إدارة المستخدمين
- صفحة مراجعة الأخبار المعلقة
- صفحة مراجعة التقارير المعلقة
- صفحة مراجعة طلبات السباكين

### 2. نظام الإشعارات:
- إشعارات عند الموافقة/الرفض
- إشعارات للمدراء عند وجود محتوى جديد للمراجعة

### 3. تقييم السباكين:
- نظام تقييم من العملاء
- تعليقات ومراجعات

### 4. البحث المتقدم:
- البحث في الأخبار بالفئات والكلمات المفتاحية
- البحث في السباكين بالتخصص والمنطقة

## الملاحظات:

1. **الأمان**: تم تطبيق Row Level Security (RLS) على جميع الجداول
2. **الأداء**: تم إضافة indexes للاستعلامات السريعة
3. **المرونة**: النظام قابل للتوسع لإضافة أنواع مستخدمين جديدة
4. **سهولة الاستخدام**: واجهة بديهية لكل نوع مستخدم
